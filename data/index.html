<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Management Car Counter</title>
    <!-- All styling now lives in /style.css -->
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <h1>File Management System Car Counter</h1>

    <!-- GAL 25-11-23.x: Quick access to Show Summary page -->
    <div class="top-buttons">
        <button onclick="window.location.href='/showSummary.html'">
            View Show Summary
        </button>
    </div>

    <div class="file-manager">
        <h2>Available Files</h2>
        <div id="fileList">
            <!-- File list will be dynamically populated -->
        </div>

        <div class="file-actions">
            <h3>Manage Files</h3>

            <input type="text" id="fileName" placeholder="Current file name">

            <div class="button-row">
                <button class="download-btn" onclick="downloadFile()">Download File</button>

                <!-- MUCH SAFER: delete moved away + red -->
                <button class="delete-btn" onclick="deleteFile()">Delete File</button>
            </div>

            <div class="rename-row">
                <input type="text" id="newFileName" placeholder="New file name (for rename)">
                <button onclick="renameFile()">Rename File</button>
            </div>
        </div>

        <div class="buttons">
            <h3>Upload a File</h3>
            <input type="file" id="uploadFile">
            <button onclick="uploadFile()">Upload</button>
        </div>

        <div class="buttons">
            <h3>Change Directory</h3>
            <input type="text" id="directoryName" placeholder="Enter directory name">
            <button onclick="changeDirectory()">Change Directory</button>
        </div>
    </div>

<script>
    // Apply theme based on device identity (CarCounter vs GateCounter)
    function applyThemeByIdentity() {
        fetch('/identity')
            .then(response => response.text())
            .then(text => {
                const id = text.trim();  // kill \r\n etc
                console.log('Identity from /identity:', JSON.stringify(id));

                if (id.endsWith('CarCounter')) {
                    document.body.classList.add('theme-car');
                } else if (id.endsWith('GateCounter')) {
                    document.body.classList.add('theme-gate');
                } else {
                    console.warn('Unknown identity:', id);
                }
            })
            .catch(err => console.error('Error fetching identity:', err));
    }

    // Fetch the list of files from the server
    function fetchFileList() {
        fetch('/listFiles')
            .then(response => response.text())
            .then(data => {
                const fileListDiv = document.getElementById('fileList');
                fileListDiv.innerHTML = data.replace(/\n/g, '<br>');
            })
            .catch(err => console.error('Error fetching file list:', err));
    }

    // Delete a file
    function deleteFile() {
        const fileName = document.getElementById('fileName').value;
        if (!fileName) {
            alert('Please enter a file name.');
            return;
        }

        if (!confirm(`Are you sure you want to DELETE "${fileName}"?\nThis cannot be undone.`)) {
            return;
        }

        fetch(`/delete?filename=${encodeURIComponent(fileName)}`)
            .then(response => response.text())
            .then(data => {
                alert(data);
                fetchFileList(); // Refresh
            })
            .catch(err => console.error('Error deleting file:', err));
    }

    // Download a file
    function downloadFile() {
        const fileName = document.getElementById('fileName').value;
        if (!fileName) {
            alert('Please enter a file name.');
            return;
        }
        window.location.href = `/download?filename=${encodeURIComponent(fileName)}`;
    }

    // Upload a file
    function uploadFile() {
        const fileInput = document.getElementById('uploadFile');
        if (fileInput.files.length === 0) {
            alert('Please select a file to upload.');
            return;
        }
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);

        fetch('/upload', {
            method: 'POST',
            body: formData
        })
            .then(response => response.text())
            .then(data => {
                alert(data);
                fetchFileList(); // Refresh file list
            })
            .catch(err => console.error('Error uploading file:', err));
    }

    // Change directory
    function changeDirectory() {
        const dirName = document.getElementById('directoryName').value;
        if (!dirName) {
            alert('Please enter a directory name.');
            return;
        }
        fetch(`/changeDirectory?dir=${encodeURIComponent(dirName)}`)
            .then(response => response.text())
            .then(data => {
                alert(data);
                fetchFileList(); // Refresh file list
            })
            .catch(err => console.error('Error changing directory:', err));
    }

    // Rename a file
    function renameFile() {
        const oldName = document.getElementById('fileName').value;
        const newName = document.getElementById('newFileName').value;

        if (!oldName) {
            alert('Please enter the current file name.');
            return;
        }
        if (!newName) {
            alert('Please enter the new file name.');
            return;
        }

        fetch(`/rename?old=${encodeURIComponent(oldName)}&new=${encodeURIComponent(newName)}`)
            .then(response => response.text())
            .then(data => {
                alert(data);
                fetchFileList(); // Refresh file list
            })
            .catch(err => console.error('Error renaming file:', err));
    }

    // Initialize on page load â€“ CALL BOTH
    window.onload = function () {
        applyThemeByIdentity();
        fetchFileList();
    };
</script>



</body>
</html>
