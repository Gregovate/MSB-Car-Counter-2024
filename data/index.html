<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Car Counter File Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/style.css">
</head>
<body class="theme-default">
    <header class="header">
        <h1 id="pageTitle">Car Counter File Manager</h1>
        <p class="subtitle">
            Device: <span id="deviceName">detecting...</span><br>
            Current directory: <span id="currentDir">unknown</span>
        </p>

        <!-- Show Summary buttons -->
        <div class="form-row" style="justify-content:center; gap:0.75rem; margin-top:0.5rem;">
            <button type="button" class="btn"
                    onclick="window.location='/showSummary.html'">
                View Show Summary
            </button>
            <button type="button" class="btn"
                    onclick="window.location='/showSummaryBuckets.html'">
                View Show Summary Buckets
            </button>
        </div>
    </header>

    <main>
        <section class="panel">
            <h2>Available Files</h2>
            <pre id="fileList" class="file-list">
Loading file list...
            </pre>
        </section>

        <section class="panel">
            <h2>File Actions</h2>

            <div class="form-row">
                <label for="fileName">File name:</label>
                <input type="text" id="fileName" placeholder="example.csv">
                <button type="button" class="btn" onclick="downloadFile()">Download</button>
                <button type="button" class="btn delete-btn" onclick="deleteFile()">Delete</button>
            </div>

            <div class="form-row">
                <label for="renameOld">Rename:</label>
                <input type="text" id="renameOld" placeholder="old-name.csv">
                <span>â†’</span>
                <input type="text" id="renameNew" placeholder="new-name.bak">
                <button type="button" class="btn" onclick="renameFile()">Rename</button>
            </div>
        </section>

        <section class="panel">
            <h2>Upload Files</h2>

            <div class="form-row">
                <input type="file" id="uploadFile">
            </div>
            <div class="form-row">
                <button type="button" class="btn" onclick="uploadToCurrent()">Upload to current directory</button>
                <button type="button" class="btn" onclick="uploadToData()">Upload to /data (UI files)</button>
            </div>
        </section>

        <section class="panel">
            <h2>Change Directory</h2>

            <div class="form-row">
                <label for="directoryName">Directory:</label>
                <input type="text" id="directoryName" placeholder="/CC/2025">
                <button type="button" class="btn" onclick="changeDirectory()">Change</button>
            </div>
        </section>
    </main>

    <script>
        // ----- Identity / theming -----
        function initIdentity() {
            fetch('/identity')
                .then(response => response.text())
                .then(text => {
                    const id = text.trim();
                    const body = document.body;
                    const deviceSpan = document.getElementById('deviceName');

                    deviceSpan.textContent = id || 'unknown';

                    if (id === 'espCarCounter' || id === 'CarCounter') {
                        body.classList.remove('theme-default');
                        body.classList.add('theme-car');
                    } else if (id === 'espGateCounter' || id === 'GateCounter') {
                        body.classList.remove('theme-default');
                        body.classList.add('theme-gate');
                    }
                })
                .catch(err => {
                    console.error('Error fetching identity:', err);
                    document.getElementById('deviceName').textContent = 'error';
                });
        }

        // ----- File list handling -----
        function parseCurrentDirFromList(text) {
            const firstLine = (text.split('\n')[0] || '');
            const marker = 'Files in ';
            const idx = firstLine.indexOf(marker);
            if (idx === -1) return null;

            let rest = firstLine.substring(idx + marker.length).trim();
            rest = rest.replace(/:$/, '');
            return rest;
        }

        function fetchFileList() {
            fetch('/listFiles')
                .then(response => response.text())
                .then(data => {
                    const fileListEl = document.getElementById('fileList');
                    fileListEl.textContent = data || 'No files reported.';

                    const currentDir = parseCurrentDirFromList(data);
                    if (currentDir) {
                        document.getElementById('currentDir').textContent = currentDir;
                    }
                })
                .catch(err => {
                    console.error('Error fetching file list:', err);
                    document.getElementById('fileList').textContent =
                        'Error fetching file list. Check console.';
                });
        }

        // ----- File actions -----
        function deleteFile() {
            const fileName = document.getElementById('fileName').value.trim();
            if (!fileName) {
                alert('Please enter a file name.');
                return;
            }

            if (!confirm('Delete file "' + fileName + '"? This cannot be undone.')) {
                return;
            }

            fetch('/delete?filename=' + encodeURIComponent(fileName))
                .then(response => response.text())
                .then(msg => {
                    alert(msg);
                    fetchFileList();
                })
                .catch(err => {
                    console.error('Error deleting file:', err);
                    alert('Error deleting file. See console for details.');
                });
        }

        function downloadFile() {
            const fileName = document.getElementById('fileName').value.trim();
            if (!fileName) {
                alert('Please enter a file name.');
                return;
            }
            window.location.href = '/download?filename=' + encodeURIComponent(fileName);
        }

        function renameFile() {
            const oldName = document.getElementById('renameOld').value.trim();
            const newName = document.getElementById('renameNew').value.trim();

            if (!oldName || !newName) {
                alert('Please enter both the old and new file names.');
                return;
            }

            fetch('/rename?old=' + encodeURIComponent(oldName) +
                  '&new=' + encodeURIComponent(newName))
                .then(response => response.text())
                .then(msg => {
                    alert(msg);
                    fetchFileList();
                })
                .catch(err => {
                    console.error('Error renaming file:', err);
                    alert('Error renaming file. See console for details.');
                });
        }

        // ----- Upload actions -----
        function getSelectedFile() {
            const input = document.getElementById('uploadFile');
            if (!input.files || input.files.length === 0) {
                alert('Please select a file to upload.');
                return null;
            }
            return input.files[0];
        }

        function uploadToCurrent() {
            const file = getSelectedFile();
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
                .then(response => response.text())
                .then(msg => {
                    alert(msg);
                    fetchFileList();
                })
                .catch(err => {
                    console.error('Error uploading file:', err);
                    alert('Error uploading file. See console for details.');
                });
        }

        function uploadToData() {
            const file = getSelectedFile();
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            fetch('/uploadToData', {
                method: 'POST',
                body: formData
            })
                .then(response => response.text())
                .then(msg => {
                    alert(msg);
                    fetchFileList();
                })
                .catch(err => {
                    console.error('Error uploading file to /data:', err);
                    alert('Error uploading to /data. See console for details.');
                });
        }

        // ----- Directory navigation -----
        function changeDirectory() {
            const dir = document.getElementById('directoryName').value.trim();
            if (!dir) {
                alert('Please enter a directory name.');
                return;
            }

            fetch('/changeDirectory?dir=' + encodeURIComponent(dir))
                .then(response => response.text())
                .then(msg => {
                    alert(msg);
                    fetchFileList();
                })
                .catch(err => {
                    console.error('Error changing directory:', err);
                    alert('Error changing directory. See console for details.');
                });
        }

        // ----- Init -----
        window.onload = function () {
            initIdentity();
            fetchFileList();
        };
    </script>
</body>
</html>
